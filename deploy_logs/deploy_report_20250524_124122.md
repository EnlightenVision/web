# éƒ¨ç½²æŠ¥å‘Š 20250524_124122

**çŠ¶æ€ï¼š** 
**å»¶è¿Ÿï¼š** 0ms
**å…³é”®è¯æ£€æµ‹ï¼š** EnlightenVision
**ç½‘å€ï¼š** [https://enlightenvision.net](https://enlightenvision.net)
**æˆåŠŸç‡ï¼š** 100% (3/3)

## æœ¬æ¬¡å˜æ›´
```
On branch main
Your branch is up to date with 'origin/main'.

Changes not staged for commit:
  (use "git add <file>..." to update what will be committed)
  (use "git restore <file>..." to discard changes in working directory)
	modified:   deploy.sh

Untracked files:
  (use "git add <file>..." to include in what will be committed)
	deploy_git_changes_20250524_124122.txt
	deploy_log_20250524_121609.txt

no changes added to commit (use "git add" and/or "git commit -a")
diff --git a/deploy.sh b/deploy.sh
index 812b4ad..adbdeda 100755
--- a/deploy.sh
+++ b/deploy.sh
@@ -1,148 +1,154 @@
 #!/bin/bash
 
-# ===================== é…ç½®éƒ¨åˆ† =====================
-PAGE_URL="https://enlightenvision.net"                 # Cloudflare Pages å®é™…ç½‘å€
-KEYWORD="EnlightenVision"                             # éƒ¨ç½²é¡µé¢åº”åŒ…å«çš„å…³é”®è¯
-CHAT_ID="413142477"                                  # Telegram Chat ID
-BOT_TOKEN="8106822194:AAF-xkNrMk6iCkVuBXz3FZRJpidgu-MoqPI"  # Telegram æœºå™¨äºº Token
-OPEN_BROWSER=true                                      # æ˜¯å¦è‡ªåŠ¨æ‰“å¼€ Safari é¢„è§ˆ
-SEND_SCREENSHOT=true                                   # æ˜¯å¦å‘é€é¡µé¢æˆªå›¾
-MAX_RETRY=3                                            # æ„å»ºå¤±è´¥æœ€å¤§é‡è¯•æ¬¡æ•°
-
-# ===================== åˆå§‹åŒ–å˜é‡ =====================
+############################################
+#         Cloudflare + Hexo ä¸€é”®éƒ¨ç½²è„šæœ¬
+#   1. æ£€æŸ¥ Git å˜æ›´ï¼Œæ— å˜æ›´è‡ªåŠ¨è·³è¿‡
+#   2. Hexo æ„å»ºã€Git æäº¤ã€æ¨é€ GitHub
+#   3. æ£€æµ‹é¡µé¢å»¶è¿Ÿä¸å…³é”®è¯åˆ¤æ–­éƒ¨ç½²
+#   4. è‡ªåŠ¨ä¿å­˜æ—¥å¿—ã€ç”Ÿæˆç»Ÿè®¡å›¾
+#   5. è‡ªåŠ¨å‘é€ Telegram æ¶ˆæ¯ï¼ˆå«å›¾è¡¨/æˆªå›¾ï¼‰
+#   6. æ„å»ºå¤±è´¥è‡ªåŠ¨é‡è¯•
+#   7. æ‰“å¼€ Safari æµè§ˆå™¨é¢„è§ˆ
+############################################
+
+# ========== é…ç½®åŒºåŸŸ ==========
+PAGE_URL="https://enlightenvision.net"   # ä½ çš„ Cloudflare Pages ç½‘å€
+KEYWORD="EnlightenVision"                # éƒ¨ç½²é¡µé¢æ£€æµ‹å…³é”®è¯
+CHAT_ID="413142477"                      # Telegram Chat ID
+BOT_TOKEN="8106822194:AAF-xkNrMk6iCkVuBXz3FZRJpidgu-MoqPI"  # Telegram Bot Token
+OPEN_BROWSER=true                        # æ˜¯å¦è‡ªåŠ¨æ‰“å¼€ Safari
+SEND_SCREENSHOT=true                     # æ˜¯å¦å‘é€é¡µé¢æˆªå›¾
+RETRY=2                                  # å¤±è´¥è‡ªåŠ¨é‡è¯•æ¬¡æ•°
+
+# ========== åˆå§‹åŒ–å˜é‡ ==========
 DATE_TAG=$(date "+%Y%m%d_%H%M%S")
-DEPLOY_DIR="/Users/zshe/evo"                            # é¡¹ç›®è·¯å¾„ï¼ˆå›ºå®šä¸ºä½ å½“å‰è·¯å¾„ï¼‰
-LOG_FILE="$DEPLOY_DIR/deploy_log_${DATE_TAG}.txt"
-HISTORY_LOG="$DEPLOY_DIR/deploy_history.log"
-
-cd "$DEPLOY_DIR" || exit 1
+LOG_FILE="deploy_log_${DATE_TAG}.txt"
+DEPLOY_DIR="$(pwd)"
+GIT_CHANGE_FILE="deploy_git_changes_${DATE_TAG}.txt"
+PNG_CHART="deploy_chart_${DATE_TAG}.png"
 
-# ===================== æ£€æŸ¥æ˜¯å¦æœ‰ Git æ”¹åŠ¨ =====================
+# ========== æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´ ==========
 echo "æ£€æŸ¥ Git çŠ¶æ€..."
-git diff --quiet && git diff --cached --quiet
-if [ $? -eq 0 ]; then
-  echo "[$DATE_TAG] æ— æ–‡ä»¶å˜åŠ¨ï¼Œåœæ­¢éƒ¨ç½²ã€‚" | tee -a "$HISTORY_LOG"
+if git diff --quiet && git diff --cached --quiet; then
+  echo "[ç•¥è¿‡] æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œåœæ­¢éƒ¨ç½²ã€‚"
+  echo "[$DATE_TAG] No changes detected. Skipped." >> deploy_history.log
   exit 0
 fi
 
-# ===================== Hexo æ„å»ºï¼ˆè‡ªåŠ¨é‡è¯•ï¼‰ =====================
-RETRY=0
-while [ $RETRY -lt $MAX_RETRY ]; do
-  echo "Hexo æ„å»ºä¸­... ç¬¬ $((RETRY+1)) æ¬¡å°è¯•"
-  hexo clean && hexo g && break
-  RETRY=$((RETRY+1))
-  echo "æ„å»ºå¤±è´¥ï¼Œé‡è¯•ä¸­ ($RETRY/$MAX_RETRY)..."
-  sleep 2
-
+# ========== æ”¶é›†æœ¬æ¬¡ Git å˜æ›´ ==========
+git status > "$GIT_CHANGE_FILE"
+git diff >> "$GIT_CHANGE_FILE"
+git diff --cached >> "$GIT_CHANGE_FILE"
+
+# ========== éƒ¨ç½²æµç¨‹(å«å¤±è´¥é‡è¯•) ==========
+TRY=0
+SUCCESS=false
+while [ $TRY -le $RETRY ]; do
+  TRY=$((TRY+1))
+  echo "ç¬¬ $TRY æ¬¡å°è¯• Hexo æ„å»º..."
+  hexo clean && hexo g
+  BUILD_SUCCESS=$?
+  if [ $BUILD_SUCCESS -eq 0 ]; then
+    # æ„å»ºæˆåŠŸ
+    git add .
+    git commit -m "Auto deploy at $DATE_TAG"
+    git push origin main
+    # æ£€æŸ¥é¡µé¢å»¶è¿Ÿä¸å…³é”®è¯
+    sleep 4  # ä¿è¯ Cloudflare ç«¯æœ‰æ—¶é—´åŒæ­¥ï¼ˆå¯è°ƒï¼‰
+    START_TIME=$(date +%s%3N)
+    HTML=$(curl -s -m 15 "$PAGE_URL")
+    END_TIME=$(date +%s%3N)
+    DELAY_MS=$((END_TIME - START_TIME))
+    if [[ "$HTML" == *"$KEYWORD"* ]]; then
+      STATUS="âœ… éƒ¨ç½²æˆåŠŸ"
+      SUCCESS=true
+      break
+    else
+      STATUS="âŒ éƒ¨ç½²å¤±è´¥ï¼šæ‰¾ä¸åˆ°å…³é”®è¯"
+    fi
+  else
+    STATUS="âŒ Hexo æ„å»ºå¤±è´¥"
+  fi
+  # æ„å»ºå¤±è´¥è‡ªåŠ¨é‡è¯•
+  if [ $TRY -le $RETRY ]; then
+    echo "éƒ¨ç½²å¤±è´¥ï¼Œ$((10*TRY))ç§’åé‡è¯•..."
+    sleep $((10 * TRY))
+  fi
 done
 
-if [ $RETRY -eq $MAX_RETRY ]; then
-  echo "âŒ æ„å»ºå¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ã€‚" | tee "$LOG_FILE"
-  curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
-    -d chat_id="${CHAT_ID}" \
-    -d text="âŒ Hexo æ„å»ºå¤±è´¥ï¼Œæœ€å¤§é‡è¯•å·²è¾¾ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥ã€‚"
-  exit 1
+# ========== æ—¥å¿—è®°å½•ä¸ç»Ÿè®¡ ==========
+echo "[$DATE_TAG] $STATUS å»¶è¿Ÿ ${DELAY_MS:-0}ms" >> deploy_history.log
+SUCCESS_COUNT=$(grep -c "âœ… éƒ¨ç½²æˆåŠŸ" deploy_history.log)
+FAIL_COUNT=$(grep -c "âŒ" deploy_history.log)
+TOTAL_COUNT=$((SUCCESS_COUNT + FAIL_COUNT))
+SUCCESS_RATE=0
+if [ $TOTAL_COUNT -ne 0 ]; then
+  SUCCESS_RATE=$((SUCCESS_COUNT * 100 / TOTAL_COUNT))
 fi
 
-# ===================== Git æäº¤ä¸æ¨é€ =====================
-CHANGES=$(git status --short)
-git add .
-git commit -m "Auto deploy at $DATE_TAG"
-git push origin main
-
-# ===================== æµ‹è¯•éƒ¨ç½²åœ°å€å»¶è¿Ÿä¸å†…å®¹ =====================
-START_TIME=$(date +%s%3N)
-HTML=$(curl -s -m 20 "$PAGE_URL")
-END_TIME=$(date +%s%3N)
-DELAY_MS=$((END_TIME - START_TIME))
-
-if [[ "$HTML" == *"$KEYWORD"* ]]; then
-  STATUS="âœ… éƒ¨ç½²æˆåŠŸ"
-  COLOR="green"
-else
-  STATUS="âŒ éƒ¨ç½²å¤±è´¥ï¼šå…³é”®è¯æœªå‘ç°"
-  COLOR="red"
-fi
+# ========== ç”Ÿæˆæœ¬åœ° HTML/Markdown ç®€æ˜“æŠ¥å‘Š ==========
+REPORT_MD="deploy_report_${DATE_TAG}.md"
+REPORT_HTML="deploy_report_${DATE_TAG}.html"
+echo -e "# éƒ¨ç½²æŠ¥å‘Š ${DATE_TAG}

**çŠ¶æ€ï¼š** $STATUS
**å»¶è¿Ÿï¼š** ${DELAY_MS:-0}ms
**å…³é”®è¯æ£€æµ‹ï¼š** $KEYWORD
**ç½‘å€ï¼š** [$PAGE_URL]($PAGE_URL)
**æˆåŠŸç‡ï¼š** $SUCCESS_RATE% ($SUCCESS_COUNT/$TOTAL_COUNT)

## æœ¬æ¬¡å˜æ›´
\`\`\`
$(cat $GIT_CHANGE_FILE)
\`\`\`" > "$REPORT_MD"
+pandoc "$REPORT_MD" -o "$REPORT_HTML" --from markdown --to html
+
+# ========== ç”Ÿæˆç»Ÿè®¡å›¾è¡¨ï¼ˆå»¶è¿Ÿ/æˆåŠŸç‡ï¼‰==========
+python3 << EOF
+import matplotlib.pyplot as plt, re
+log_path = "deploy_history.log"
+delays = []
+statuses = []
+with open(log_path) as f:
+    for line in f:
+        m = re.search(r'(\d+)ms', line)
+        if m: delays.append(int(m.group(1)))
+        statuses.append("æˆåŠŸ" if "âœ…" in line else "å¤±è´¥")
+fig, ax = plt.subplots()
+ax.plot(delays, marker='o', label='å»¶è¿Ÿ(ms)')
+ax.set_xlabel("éƒ¨ç½²æ¬¡æ•°")
+ax.set_ylabel("å»¶è¿Ÿ(ms)")
+ax2 = ax.twinx()
+ax2.plot([i for i,s in enumerate(statuses) if s=="æˆåŠŸ"], [delays[i] for i,s in enumerate(statuses) if s=="æˆåŠŸ"], 'g.', label='æˆåŠŸ', alpha=0.5)
+ax2.plot([i for i,s in enumerate(statuses) if s=="å¤±è´¥"], [delays[i] for i,s in enumerate(statuses) if s=="å¤±è´¥"], 'r.', label='å¤±è´¥', alpha=0.5)
+plt.title("éƒ¨ç½²å»¶è¿Ÿ & æˆåŠŸåˆ†å¸ƒ")
+plt.savefig("$PNG_CHART")
+EOF
 
-# ===================== è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ =====================
+# ========== è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ ==========
 if $OPEN_BROWSER; then
-  echo "æ‰“å¼€ Safari é¢„è§ˆ..."
   open -a Safari "$PAGE_URL"
 fi
 
-# ===================== ä¿å­˜å†å²æ—¥å¿— =====================
-echo "[$DATE_TAG] $STATUS å»¶è¿Ÿ ${DELAY_MS}ms" | tee "$LOG_FILE" >> "$HISTORY_LOG"
-SUCCESS_COUNT=$(grep -c "âœ… éƒ¨ç½²æˆåŠŸ" "$HISTORY_LOG")
-FAIL_COUNT=$(grep -c "âŒ" "$HISTORY_LOG")
-TOTAL_COUNT=$((SUCCESS_COUNT + FAIL_COUNT))
-if [ $TOTAL_COUNT -gt 0 ]; then
-  SUCCESS_RATE=$((SUCCESS_COUNT * 100 / TOTAL_COUNT))
-else
-  SUCCESS_RATE=0
-fi
-
-# ===================== ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š HTML =====================
+# ========== Telegram HTML æŠ¥å‘Š ==========
 HTML_REPORT="<b>${STATUS}</b><br>
 å…³é”®è¯: <code>${KEYWORD}</code><br>
-å»¶è¿Ÿ: <code>${DELAY_MS} ms</code><br>
+å»¶è¿Ÿ: <code>${DELAY_MS:-0} ms</code><br>
 éƒ¨ç½²æ—¶é—´: <code>${DATE_TAG}</code><br>
 æˆåŠŸç‡: <b>${SUCCESS_RATE}%</b> (${SUCCESS_COUNT}/${TOTAL_COUNT})<br>
-ğŸ”— <a href='${PAGE_URL}'>ç‚¹æˆ‘é¢„è§ˆ</a><br>
-ğŸ“„ <pre>${CHANGES}</pre>"
+ğŸ”— <a href='${PAGE_URL}'>é¢„è§ˆç½‘ç«™</a><br>
+<pre>å˜æ›´:
$(tail -20 $GIT_CHANGE_FILE | sed 's/</\&lt;/g; s/>/\&gt;/g;')</pre>"
 
-# ===================== æ¨é€ Telegram æŠ¥å‘Š =====================
 curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
-  -d chat_id="${CHAT_ID}" \
+  -d chat_id="$CHAT_ID" \
   -d text="$HTML_REPORT" \
   -d parse_mode="HTML"
 
-# ===================== é¡µé¢æˆªå›¾ï¼ˆå®Œæ•´ï¼‰ =====================
+# ========== Telegram ç»Ÿè®¡å›¾è¡¨ ==========
+curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto" \
+  -F chat_id="$CHAT_ID" \
+  -F photo=@"$PNG_CHART" \
+  -F caption="ğŸ“ˆ éƒ¨ç½²å»¶è¿Ÿå’ŒæˆåŠŸç‡ç»Ÿè®¡"
+
+# ========== é¡µé¢æˆªå›¾ï¼ˆSafari é¡µé¢åŠ è½½åŠ¨ç”»å»¶è¿Ÿï¼‰==========
 if $SEND_SCREENSHOT; then
-  echo "å‡†å¤‡æˆªå›¾..."
-  sleep 3
   SCREENSHOT_PATH="/tmp/page_shot_${DATE_TAG}.png"
-  screencapture -x -R0,0,1280,800 "$SCREENSHOT_PATH"
+  sleep 4  # å»¶è¿Ÿï¼Œç¡®ä¿åŠ¨ç”»ç»“æŸ
+  screencapture -x -R0,0,1280,900 "$SCREENSHOT_PATH"
   curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto" \
-    -F chat_id="${CHAT_ID}" \
+    -F chat_id="$CHAT_ID" \
     -F photo="@${SCREENSHOT_PATH}" \
-    -F caption="ğŸ“¸ é¡µé¢æˆªå›¾"
+    -F caption="ğŸ“¸ é¡µé¢æˆªå›¾ (${DATE_TAG})"
 fi
 
-# ===================== ç”ŸæˆæˆåŠŸç‡å›¾è¡¨ï¼ˆå¯é€‰ï¼‰ =====================
-python3 <<EOF
-import matplotlib.pyplot as plt
-import re
-from datetime import datetime
-
-lines = open("$HISTORY_LOG").readlines()
-dates, statuses, delays = [], [], []
-for line in lines:
-    m = re.match(r"\[(.*?)\] (.*?) å»¶è¿Ÿ (\d+)ms", line)
-    if m:
-        dt = datetime.strptime(m[1], "%Y%m%d_%H%M%S")
-        dates.append(dt)
-        statuses.append("æˆåŠŸ" if "âœ…" in m[2] else "å¤±è´¥")
-        delays.append(int(m[3]))
-
-plt.figure(figsize=(10, 4))
-colors = ["green" if s == "æˆåŠŸ" else "red" for s in statuses]
-plt.bar(dates, delays, color=colors)
-plt.xticks(rotation=45)
-plt.title("éƒ¨ç½²å»¶è¿Ÿè¶‹åŠ¿å›¾")
-plt.ylabel("å»¶è¿Ÿ (ms)")
-plt.tight_layout()
-chart_path = "$DEPLOY_DIR/deploy_chart_${DATE_TAG}.png"
-plt.savefig(chart_path)
-
-# æ¨é€å›¾è¡¨åˆ° Telegram
-import requests
-requests.post(
-    f"https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto",
-    data={"chat_id": "$CHAT_ID"},
-    files={"photo": open(chart_path, "rb")}
-)
-EOF
-
-# ===================== ç»“æŸ =====================
 echo "éƒ¨ç½²å®Œæˆ âœ…"
 exit 0
\ No newline at end of file
```
