# 部署报告 20250524_124122

**状态：** 
**延迟：** 0ms
**关键词检测：** EnlightenVision
**网址：** [https://enlightenvision.net](https://enlightenvision.net)
**成功率：** 100% (3/3)

## 本次变更
```
On branch main
Your branch is up to date with 'origin/main'.

Changes not staged for commit:
  (use "git add <file>..." to update what will be committed)
  (use "git restore <file>..." to discard changes in working directory)
	modified:   deploy.sh

Untracked files:
  (use "git add <file>..." to include in what will be committed)
	deploy_git_changes_20250524_124122.txt
	deploy_log_20250524_121609.txt

no changes added to commit (use "git add" and/or "git commit -a")
diff --git a/deploy.sh b/deploy.sh
index 812b4ad..adbdeda 100755
--- a/deploy.sh
+++ b/deploy.sh
@@ -1,148 +1,154 @@
 #!/bin/bash
 
-# ===================== 配置部分 =====================
-PAGE_URL="https://enlightenvision.net"                 # Cloudflare Pages 实际网址
-KEYWORD="EnlightenVision"                             # 部署页面应包含的关键词
-CHAT_ID="413142477"                                  # Telegram Chat ID
-BOT_TOKEN="8106822194:AAF-xkNrMk6iCkVuBXz3FZRJpidgu-MoqPI"  # Telegram 机器人 Token
-OPEN_BROWSER=true                                      # 是否自动打开 Safari 预览
-SEND_SCREENSHOT=true                                   # 是否发送页面截图
-MAX_RETRY=3                                            # 构建失败最大重试次数
-
-# ===================== 初始化变量 =====================
+############################################
+#         Cloudflare + Hexo 一键部署脚本
+#   1. 检查 Git 变更，无变更自动跳过
+#   2. Hexo 构建、Git 提交、推送 GitHub
+#   3. 检测页面延迟与关键词判断部署
+#   4. 自动保存日志、生成统计图
+#   5. 自动发送 Telegram 消息（含图表/截图）
+#   6. 构建失败自动重试
+#   7. 打开 Safari 浏览器预览
+############################################
+
+# ========== 配置区域 ==========
+PAGE_URL="https://enlightenvision.net"   # 你的 Cloudflare Pages 网址
+KEYWORD="EnlightenVision"                # 部署页面检测关键词
+CHAT_ID="413142477"                      # Telegram Chat ID
+BOT_TOKEN="8106822194:AAF-xkNrMk6iCkVuBXz3FZRJpidgu-MoqPI"  # Telegram Bot Token
+OPEN_BROWSER=true                        # 是否自动打开 Safari
+SEND_SCREENSHOT=true                     # 是否发送页面截图
+RETRY=2                                  # 失败自动重试次数
+
+# ========== 初始化变量 ==========
 DATE_TAG=$(date "+%Y%m%d_%H%M%S")
-DEPLOY_DIR="/Users/zshe/evo"                            # 项目路径（固定为你当前路径）
-LOG_FILE="$DEPLOY_DIR/deploy_log_${DATE_TAG}.txt"
-HISTORY_LOG="$DEPLOY_DIR/deploy_history.log"
-
-cd "$DEPLOY_DIR" || exit 1
+LOG_FILE="deploy_log_${DATE_TAG}.txt"
+DEPLOY_DIR="$(pwd)"
+GIT_CHANGE_FILE="deploy_git_changes_${DATE_TAG}.txt"
+PNG_CHART="deploy_chart_${DATE_TAG}.png"
 
-# ===================== 检查是否有 Git 改动 =====================
+# ========== 检查是否有变更 ==========
 echo "检查 Git 状态..."
-git diff --quiet && git diff --cached --quiet
-if [ $? -eq 0 ]; then
-  echo "[$DATE_TAG] 无文件变动，停止部署。" | tee -a "$HISTORY_LOG"
+if git diff --quiet && git diff --cached --quiet; then
+  echo "[略过] 没有文件变更，停止部署。"
+  echo "[$DATE_TAG] No changes detected. Skipped." >> deploy_history.log
   exit 0
 fi
 
-# ===================== Hexo 构建（自动重试） =====================
-RETRY=0
-while [ $RETRY -lt $MAX_RETRY ]; do
-  echo "Hexo 构建中... 第 $((RETRY+1)) 次尝试"
-  hexo clean && hexo g && break
-  RETRY=$((RETRY+1))
-  echo "构建失败，重试中 ($RETRY/$MAX_RETRY)..."
-  sleep 2
-
+# ========== 收集本次 Git 变更 ==========
+git status > "$GIT_CHANGE_FILE"
+git diff >> "$GIT_CHANGE_FILE"
+git diff --cached >> "$GIT_CHANGE_FILE"
+
+# ========== 部署流程(含失败重试) ==========
+TRY=0
+SUCCESS=false
+while [ $TRY -le $RETRY ]; do
+  TRY=$((TRY+1))
+  echo "第 $TRY 次尝试 Hexo 构建..."
+  hexo clean && hexo g
+  BUILD_SUCCESS=$?
+  if [ $BUILD_SUCCESS -eq 0 ]; then
+    # 构建成功
+    git add .
+    git commit -m "Auto deploy at $DATE_TAG"
+    git push origin main
+    # 检查页面延迟与关键词
+    sleep 4  # 保证 Cloudflare 端有时间同步（可调）
+    START_TIME=$(date +%s%3N)
+    HTML=$(curl -s -m 15 "$PAGE_URL")
+    END_TIME=$(date +%s%3N)
+    DELAY_MS=$((END_TIME - START_TIME))
+    if [[ "$HTML" == *"$KEYWORD"* ]]; then
+      STATUS="✅ 部署成功"
+      SUCCESS=true
+      break
+    else
+      STATUS="❌ 部署失败：找不到关键词"
+    fi
+  else
+    STATUS="❌ Hexo 构建失败"
+  fi
+  # 构建失败自动重试
+  if [ $TRY -le $RETRY ]; then
+    echo "部署失败，$((10*TRY))秒后重试..."
+    sleep $((10 * TRY))
+  fi
 done
 
-if [ $RETRY -eq $MAX_RETRY ]; then
-  echo "❌ 构建失败，已达到最大重试次数。" | tee "$LOG_FILE"
-  curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
-    -d chat_id="${CHAT_ID}" \
-    -d text="❌ Hexo 构建失败，最大重试已达，请手动检查。"
-  exit 1
+# ========== 日志记录与统计 ==========
+echo "[$DATE_TAG] $STATUS 延迟 ${DELAY_MS:-0}ms" >> deploy_history.log
+SUCCESS_COUNT=$(grep -c "✅ 部署成功" deploy_history.log)
+FAIL_COUNT=$(grep -c "❌" deploy_history.log)
+TOTAL_COUNT=$((SUCCESS_COUNT + FAIL_COUNT))
+SUCCESS_RATE=0
+if [ $TOTAL_COUNT -ne 0 ]; then
+  SUCCESS_RATE=$((SUCCESS_COUNT * 100 / TOTAL_COUNT))
 fi
 
-# ===================== Git 提交与推送 =====================
-CHANGES=$(git status --short)
-git add .
-git commit -m "Auto deploy at $DATE_TAG"
-git push origin main
-
-# ===================== 测试部署地址延迟与内容 =====================
-START_TIME=$(date +%s%3N)
-HTML=$(curl -s -m 20 "$PAGE_URL")
-END_TIME=$(date +%s%3N)
-DELAY_MS=$((END_TIME - START_TIME))
-
-if [[ "$HTML" == *"$KEYWORD"* ]]; then
-  STATUS="✅ 部署成功"
-  COLOR="green"
-else
-  STATUS="❌ 部署失败：关键词未发现"
-  COLOR="red"
-fi
+# ========== 生成本地 HTML/Markdown 简易报告 ==========
+REPORT_MD="deploy_report_${DATE_TAG}.md"
+REPORT_HTML="deploy_report_${DATE_TAG}.html"
+echo -e "# 部署报告 ${DATE_TAG}

**状态：** $STATUS
**延迟：** ${DELAY_MS:-0}ms
**关键词检测：** $KEYWORD
**网址：** [$PAGE_URL]($PAGE_URL)
**成功率：** $SUCCESS_RATE% ($SUCCESS_COUNT/$TOTAL_COUNT)

## 本次变更
\`\`\`
$(cat $GIT_CHANGE_FILE)
\`\`\`" > "$REPORT_MD"
+pandoc "$REPORT_MD" -o "$REPORT_HTML" --from markdown --to html
+
+# ========== 生成统计图表（延迟/成功率）==========
+python3 << EOF
+import matplotlib.pyplot as plt, re
+log_path = "deploy_history.log"
+delays = []
+statuses = []
+with open(log_path) as f:
+    for line in f:
+        m = re.search(r'(\d+)ms', line)
+        if m: delays.append(int(m.group(1)))
+        statuses.append("成功" if "✅" in line else "失败")
+fig, ax = plt.subplots()
+ax.plot(delays, marker='o', label='延迟(ms)')
+ax.set_xlabel("部署次数")
+ax.set_ylabel("延迟(ms)")
+ax2 = ax.twinx()
+ax2.plot([i for i,s in enumerate(statuses) if s=="成功"], [delays[i] for i,s in enumerate(statuses) if s=="成功"], 'g.', label='成功', alpha=0.5)
+ax2.plot([i for i,s in enumerate(statuses) if s=="失败"], [delays[i] for i,s in enumerate(statuses) if s=="失败"], 'r.', label='失败', alpha=0.5)
+plt.title("部署延迟 & 成功分布")
+plt.savefig("$PNG_CHART")
+EOF
 
-# ===================== 自动打开浏览器 =====================
+# ========== 自动打开浏览器 ==========
 if $OPEN_BROWSER; then
-  echo "打开 Safari 预览..."
   open -a Safari "$PAGE_URL"
 fi
 
-# ===================== 保存历史日志 =====================
-echo "[$DATE_TAG] $STATUS 延迟 ${DELAY_MS}ms" | tee "$LOG_FILE" >> "$HISTORY_LOG"
-SUCCESS_COUNT=$(grep -c "✅ 部署成功" "$HISTORY_LOG")
-FAIL_COUNT=$(grep -c "❌" "$HISTORY_LOG")
-TOTAL_COUNT=$((SUCCESS_COUNT + FAIL_COUNT))
-if [ $TOTAL_COUNT -gt 0 ]; then
-  SUCCESS_RATE=$((SUCCESS_COUNT * 100 / TOTAL_COUNT))
-else
-  SUCCESS_RATE=0
-fi
-
-# ===================== 生成部署报告 HTML =====================
+# ========== Telegram HTML 报告 ==========
 HTML_REPORT="<b>${STATUS}</b><br>
 关键词: <code>${KEYWORD}</code><br>
-延迟: <code>${DELAY_MS} ms</code><br>
+延迟: <code>${DELAY_MS:-0} ms</code><br>
 部署时间: <code>${DATE_TAG}</code><br>
 成功率: <b>${SUCCESS_RATE}%</b> (${SUCCESS_COUNT}/${TOTAL_COUNT})<br>
-🔗 <a href='${PAGE_URL}'>点我预览</a><br>
-📄 <pre>${CHANGES}</pre>"
+🔗 <a href='${PAGE_URL}'>预览网站</a><br>
+<pre>变更:
$(tail -20 $GIT_CHANGE_FILE | sed 's/</\&lt;/g; s/>/\&gt;/g;')</pre>"
 
-# ===================== 推送 Telegram 报告 =====================
 curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
-  -d chat_id="${CHAT_ID}" \
+  -d chat_id="$CHAT_ID" \
   -d text="$HTML_REPORT" \
   -d parse_mode="HTML"
 
-# ===================== 页面截图（完整） =====================
+# ========== Telegram 统计图表 ==========
+curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto" \
+  -F chat_id="$CHAT_ID" \
+  -F photo=@"$PNG_CHART" \
+  -F caption="📈 部署延迟和成功率统计"
+
+# ========== 页面截图（Safari 页面加载动画延迟）==========
 if $SEND_SCREENSHOT; then
-  echo "准备截图..."
-  sleep 3
   SCREENSHOT_PATH="/tmp/page_shot_${DATE_TAG}.png"
-  screencapture -x -R0,0,1280,800 "$SCREENSHOT_PATH"
+  sleep 4  # 延迟，确保动画结束
+  screencapture -x -R0,0,1280,900 "$SCREENSHOT_PATH"
   curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto" \
-    -F chat_id="${CHAT_ID}" \
+    -F chat_id="$CHAT_ID" \
     -F photo="@${SCREENSHOT_PATH}" \
-    -F caption="📸 页面截图"
+    -F caption="📸 页面截图 (${DATE_TAG})"
 fi
 
-# ===================== 生成成功率图表（可选） =====================
-python3 <<EOF
-import matplotlib.pyplot as plt
-import re
-from datetime import datetime
-
-lines = open("$HISTORY_LOG").readlines()
-dates, statuses, delays = [], [], []
-for line in lines:
-    m = re.match(r"\[(.*?)\] (.*?) 延迟 (\d+)ms", line)
-    if m:
-        dt = datetime.strptime(m[1], "%Y%m%d_%H%M%S")
-        dates.append(dt)
-        statuses.append("成功" if "✅" in m[2] else "失败")
-        delays.append(int(m[3]))
-
-plt.figure(figsize=(10, 4))
-colors = ["green" if s == "成功" else "red" for s in statuses]
-plt.bar(dates, delays, color=colors)
-plt.xticks(rotation=45)
-plt.title("部署延迟趋势图")
-plt.ylabel("延迟 (ms)")
-plt.tight_layout()
-chart_path = "$DEPLOY_DIR/deploy_chart_${DATE_TAG}.png"
-plt.savefig(chart_path)
-
-# 推送图表到 Telegram
-import requests
-requests.post(
-    f"https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto",
-    data={"chat_id": "$CHAT_ID"},
-    files={"photo": open(chart_path, "rb")}
-)
-EOF
-
-# ===================== 结束 =====================
 echo "部署完成 ✅"
 exit 0
\ No newline at end of file
```
